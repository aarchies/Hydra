# Hydra - 工业网络流量分析系统

## 系统特点

1. **高性能并发处理**
   - 基于MPG(Multi-Process-Go)并发模型
   - 父子进程架构设计
   - 动态负载均衡
   - 自适应资源调度

2. **插件化架构**
   - 模块化设计
   - 可扩展的插件系统
   - 灵活的协议解析
   - 丰富的分析能力

3. **高效进程间通信**
   - 基于共享内存的IPC
   - 无锁环形缓冲区
   - Futex同步原语
   - 批量数据传输

4. **智能调度系统**
   - 三维权重动态计算
   - 自适应负载均衡
   - 资源使用监控
   - 故障自动恢复

5. **协议支持**
   - Modbus/TCP
   - S7COMM
   - IEC 60870-5-104
   - DNP3
   - BACnet
   - 等800多种工业协议

# 项目结构

```shell
├── build/
│   ├── plugs/                # wireshark 插件
│   └── suricata-7.0.5.tar.gz # suricata 源码安装包
├── include/
│   ├── lib/unix/             # 动态库文件
│   ├── lib/win/              # 动态库文件
│   ├── libparser.h           # Go 导出的头文件
│   └── tshark.h              # tshark 头文件
├── internal/
│   ├── core/                 # 核心逻辑
│   └── plugin/               # 插件系统
│       ├── session/          # 会话管理插件
│       │   ├── handler.go    # 会话处理
│       │   ├── config.go     # 会话配置
│       │   └── pb/           # Protobuf 定义
│       │
│       ├── store/            # 存储插件
│       │   ├── handler.go    # 存储处理
│       │   └── config.go     # 存储配置
│       │
│       ├── warn/             # 告警插件
│       │   ├── handler.go    # 告警处理
│       │   └── config.go     # 告警配置
│       │
│       └── offline/          # 离线分析插件
│           ├── handler.go    # 离线处理
│           └── config.go     # 离线配置
├── export/                   # 导出函数
│   ├── func.go               # C 导出函数
│   ├── packet.go             # 数据包处理
│   └── socket.go             # Socket 服务
└── main.go                   # 入口文件
```

## 开发须知

1. 新增插件需要注册插件 根目录下plugin.cfg,可参考现有插件注册方式
2. include cgo头文件，分别在win/unix 加载lib目录中的dll或者so文件
3. 插件开发需遵循标准接口规范
4. 所有插件按照plugin.cfg中的顺序依次执行

## 系统架构

### 1. MPG并发模型
```shell
                      +----------------+
                      |    主进程      |
                      +--------+-------+
                               |
                      +--------v-------+
                      |   调度中心     |
                      +--------+-------+
                               |
              +----------------+-----------------+
              |                |                |
        +-----v-----+    +-----v-----+    +-----v-----+
        | 工作进程1  |    | 工作进程2  |    | 工作进程N  |
        +-----------+    +-----------+    +-----------+
```

### 2. 进程间通信
```shell
1. 共享内存通信
   - 环形缓冲区设计
   - 无锁队列实现
   - Futex同步机制
   
2. 数据流结构
   - Header (64字节对齐)
   - Buffer (1MB大小)
   - 批量传输(32条/批)
```

### 3. 调度算法

```shell
1. 父进程权重计算
   0.4*(CPU使用率) + 0.3*(任务队列) + 0.3*(内存使用率)

2. 子进程权重计算
   0.5*(CPU使用率) + 0.2*(任务队列) + 0.3*(内存使用率)

3. 动态调整策略
   - CPU > 70% 触发扩容
   - CPU < 30% 触发缩容
   - 任务堆积自动负载均衡
```

### 4. 插件系统

```shell
1. 标准插件接口
   - Handle(result *ConsumerData)
   - Init() error
   - Close() error

2. 内置插件
   - 异常处理(exception)
   - 协议解析(explain)
   - 资产识别(asset)
   - 特征分析(portrait)
   - 告警处理(warn)
   - 会话管理(session)
   - 数据存储(store)

3. 插件执行流程
   exception -> explain -> asset -> portrait -> warn -> session -> store
```

### 5. 数据处理流程

```shell
1. 数据输入
   ├── Socket接收
   ├── 导出函数调用
   └── 离线文件分析

2. 核心处理
   ├── 数据包解析(Tshark)
   ├── 协议识别
   ├── 特征提取
   └── 告警分析

3. 结果输出
   ├── 实时告警
   ├── 会话记录
   ├── 资产信息
   └── 统计数据
```

## 自愈机制

```shell
1. 健康检查
   - 定期检测进程状态
   - 监控资源使用情况
   - 检查任务处理延迟

2. 故障处理
   - 进程异常自动重启
   - 任务自动重分配
   - 资源动态调整

3. 数据保护
   - 共享内存持久化
   - 任务队列备份
   - 状态自动恢复
```

## 性能优化

1. 内存管理
   - 页面预分配
   - 缓存行对齐
   - 内存池复用

2. 调度优化
   - CPU亲和性绑定
   - NUMA感知调度
   - 批量任务处理

3. 通信优化
   - 零拷贝传输
   - 批量数据传输
   - 异步消息处理

## 许可证

[LICENSE](LICENSE)
